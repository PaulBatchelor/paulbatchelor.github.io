<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<link rel="stylesheet" href="/css/style.css">

</head>
<body>
<div id="main">

<h3>23. The Zoom Buffer</h3>

<p><a id="wm_000_3031"></a>The zoom buffer is a special buffer allocated any time the
main graphics frame buffer has a zoom factor greater than
1. Anytime a zoomed framebuffer encounters a write
operation, it will render a scaled version of itself to the
zoom buffer to then be written.
</p>
<div><b><i>&lt;&lt;monolith_framebuffer_contents&gt;&gt;=</i></b></div><pre><code>monolith_pixel *zoom_buf;</pre></code>
<p></p>
<p>The zoom buffer is only allocated when the zoom facter is
set to be greater than 1. It is otherwise initialized to be
NULL.
</p>
<div><b><i>&lt;&lt;monolith_framebuffer_init&gt;&gt;=</i></b></div><pre><code>fb-&gt;zoom_buf = NULL;</pre></code>
<p></p>
<p>The size of the zoom buffer is stored in a <code>size_t</code> variable
called <code>zoom_buf_size</code>. This can is used to prevent
unncessary mallocs.
</p>
<div><b><i>&lt;&lt;monolith_framebuffer_contents&gt;&gt;=</i></b></div><pre><code>size_t zoom_buf_size;</pre></code>
<div><b><i>&lt;&lt;monolith_framebuffer_init&gt;&gt;=</i></b></div><pre><code>fb-&gt;zoom_buf_size = 0;</pre></code>
<p></p>
<br>
<div><b><i>&lt;&lt;monolith_framebuffer_clean&gt;&gt;=</i></b></div><pre><code>free(fb-&gt;zoom_buf);
fb-&gt;zoom_buf = NULL;</pre></code>
<p></p>
<p>Anytime a zoom buffer potentially needs to be allocated, the
function <code>alloc_zoom_buffer</code> is called. This is expected to
be called after dimensions are set, or the zoom amount is
set.
</p>
<div><b><i>&lt;&lt;static_function_declarations&gt;&gt;=</i></b></div><pre><code>static void alloc_zoom_buffer(monolith_framebuffer *fb);</pre></code>
<p></p>
<p>The zoom buffer will only be used if the zoom setting is
set to be greater than 1. If it is 1, than nothing will
happen.
</p>
<p>The needed size of the zoom buffer is calculated. If the
current size is less than the needed size, or the zoom
buffer is NULL, then an allocation happens.
</p>
<p>Finally, the previous zoom buffer is freed (no need to
check for NULL, standard free shouldn't care), and then
malloc is called to allocate the buffer.
</p>
<div><b><i>&lt;&lt;functions&gt;&gt;=</i></b></div><pre><code>static void alloc_zoom_buffer(monolith_framebuffer *fb)
{
    size_t needed;
    if(fb-&gt;zoom &lt;= 1) return;

    needed = fb-&gt;w * fb-&gt;zoom * fb-&gt;h * fb-&gt;zoom;

    if(needed &gt; fb-&gt;zoom_buf_size || fb-&gt;zoom_buf == NULL) {
        free(fb-&gt;zoom_buf);
        fb-&gt;zoom_buf = calloc(1, needed * sizeof(monolith_pixel));
        fb-&gt;zoom_buf_size = needed;
    }
}</pre></code>
<p></p>
<p>A framebuffer will copy and rescale itself to the zoom
buffer in a single operation. This is done with the function
<code>zbuf_rescale</code>. This will not do any checks, so sanitize
before calling this guy.
</p>
<div><b><i>&lt;&lt;static_function_declarations&gt;&gt;=</i></b></div><pre><code>#ifdef MONOLITH_H264
static void zbuf_rescale(monolith_pixel *pix,
                         monolith_pixel *zbuf,
                         unsigned int w,
                         unsigned int h,
                         int zoom);
#endif</pre></code>
<div><b><i>&lt;&lt;functions&gt;&gt;=</i></b></div><pre><code>#ifdef MONOLITH_H264
static void zbuf_rescale(monolith_pixel *pix,
                         monolith_pixel *zbuf,
                         unsigned int w,
                         unsigned int h,
                         int zoom)
{
    unsigned int x, y, xi, yi;
    unsigned int pos;
    unsigned int pos_zoom;

    pos = 0;
    pos_zoom = 0;

    for(y = 0; y &lt; h; y++) {
        for(x = 0; x &lt; w; x++) {
            pos = y * w + x;
            for(yi = 0; yi &lt; zoom; yi++) {
                for(xi = 0; xi &lt; zoom; xi++) {
                    pos_zoom =
                        y * zoom * w * zoom +
                        x * zoom +
                        yi * w * zoom +
                        xi;
                    zbuf[pos_zoom] = pix[pos];
                }
            }
        }
    }
}
#endif</pre></code>
</div>
</body>
</html>
