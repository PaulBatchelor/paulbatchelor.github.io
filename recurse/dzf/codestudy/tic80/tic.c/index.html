<p><!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="/recurse/css/code.css">
<title>codestudy/tic80/tic.c</title>
</head>
<body>
<div class="container-fluid code-viewport">
<div class="row mr-0">
<div class="code-view">
<pre class="lines"><a href="#L1" id="L1">1</a>
<a href="#L2" id="L2">2</a>
<a href="#L3" id="L3">3</a>
<a href="#L4" id="L4">4</a>
<a href="#L5" id="L5">5</a>
<a href="#L6" id="L6">6</a>
<a href="#L7" id="L7">7</a>
<a href="#L8" id="L8">8</a>
<a href="#L9" id="L9">9</a>
<a href="#L10" id="L10">10</a>
<a href="#L11" id="L11">11</a>
<a href="#L12" id="L12">12</a>
<a href="#L13" id="L13">13</a>
<a href="#L14" id="L14">14</a>
<a href="#L15" id="L15">15</a>
<a href="#L16" id="L16">16</a>
<a href="#L17" id="L17">17</a>
<a href="#L18" id="L18">18</a>
<a href="#L19" id="L19">19</a>
<a href="#L20" id="L20">20</a>
<a href="#L21" id="L21">21</a>
<a href="#L22" id="L22">22</a>
<a href="#L23" id="L23">23</a>
<a href="#L24" id="L24">24</a>
<a href="#L25" id="L25">25</a>
<a href="#L26" id="L26">26</a>
<a href="#L27" id="L27">27</a>
<a href="#L28" id="L28">28</a>
<a href="#L29" id="L29">29</a>
<a href="#L30" id="L30">30</a>
<a href="#L31" id="L31">31</a>
<a href="#L32" id="L32">32</a>
<a href="#L33" id="L33">33</a>
<a href="#L34" id="L34">34</a>
<a href="#L35" id="L35">35</a>
<a href="#L36" id="L36">36</a>
<a href="#L37" id="L37">37</a>
<a href="#L38" id="L38">38</a>
<a href="#L39" id="L39">39</a>
<a href="#L40" id="L40">40</a>
<a href="#L41" id="L41">41</a>
<a href="#L42" id="L42">42</a>
<a href="#L43" id="L43">43</a>
<a href="#L44" id="L44">44</a>
<a href="#L45" id="L45">45</a>
<a href="#L46" id="L46">46</a>
<a href="#L47" id="L47">47</a>
<a href="#L48" id="L48">48</a>
<a href="#L49" id="L49">49</a>
<a href="#L50" id="L50">50</a>
<a href="#L51" id="L51">51</a>
<a href="#L52" id="L52">52</a>
<a href="#L53" id="L53">53</a>
<a href="#L54" id="L54">54</a>
<a href="#L55" id="L55">55</a>
<a href="#L56" id="L56">56</a>
<a href="#L57" id="L57">57</a>
<a href="#L58" id="L58">58</a>
<a href="#L59" id="L59">59</a>
<a href="#L60" id="L60">60</a>
<a href="#L61" id="L61">61</a>
<a href="#L62" id="L62">62</a>
<a href="#L63" id="L63">63</a>
<a href="#L64" id="L64">64</a>
<a href="#L65" id="L65">65</a>
<a href="#L66" id="L66">66</a>
<a href="#L67" id="L67">67</a>
<a href="#L68" id="L68">68</a>
<a href="#L69" id="L69">69</a>
<a href="#L70" id="L70">70</a>
<a href="#L71" id="L71">71</a>
<a href="#L72" id="L72">72</a>
<a href="#L73" id="L73">73</a>
<a href="#L74" id="L74">74</a>
<a href="#L75" id="L75">75</a>
<a href="#L76" id="L76">76</a>
<a href="#L77" id="L77">77</a>
<a href="#L78" id="L78">78</a>
<a href="#L79" id="L79">79</a>
<a href="#L80" id="L80">80</a>
<a href="#L81" id="L81">81</a>
<a href="#L82" id="L82">82</a>
<a href="#L83" id="L83">83</a>
<a href="#L84" id="L84">84</a>
<a href="#L85" id="L85">85</a>
<a href="#L86" id="L86">86</a>
<a href="#L87" id="L87">87</a>
<a href="#L88" id="L88">88</a>
<a href="#L89" id="L89">89</a>
<a href="#L90" id="L90">90</a>
<a href="#L91" id="L91">91</a>
<a href="#L92" id="L92">92</a>
<a href="#L93" id="L93">93</a>
<a href="#L94" id="L94">94</a>
<a href="#L95" id="L95">95</a>
<a href="#L96" id="L96">96</a>
<a href="#L97" id="L97">97</a>
<a href="#L98" id="L98">98</a>
<a href="#L99" id="L99">99</a>
<a href="#L100" id="L100">100</a>
<a href="#L101" id="L101">101</a>
<a href="#L102" id="L102">102</a>
<a href="#L103" id="L103">103</a>
<a href="#L104" id="L104">104</a>
<a href="#L105" id="L105">105</a>
<a href="#L106" id="L106">106</a>
<a href="#L107" id="L107">107</a>
<a href="#L108" id="L108">108</a>
<a href="#L109" id="L109">109</a>
<a href="#L110" id="L110">110</a>
<a href="#L111" id="L111">111</a>
<a href="#L112" id="L112">112</a>
<a href="#L113" id="L113">113</a>
<a href="#L114" id="L114">114</a>
<a href="#L115" id="L115">115</a>
<a href="#L116" id="L116">116</a>
<a href="#L117" id="L117">117</a>
<a href="#L118" id="L118">118</a>
<a href="#L119" id="L119">119</a>
<a href="#L120" id="L120">120</a>
<a href="#L121" id="L121">121</a>
<a href="#L122" id="L122">122</a>
<a href="#L123" id="L123">123</a>
<a href="#L124" id="L124">124</a>
<a href="#L125" id="L125">125</a>
<a href="#L126" id="L126">126</a>
<a href="#L127" id="L127">127</a>
<a href="#L128" id="L128">128</a>
<a href="#L129" id="L129">129</a>
<a href="#L130" id="L130">130</a>
<a href="#L131" id="L131">131</a>
<a href="#L132" id="L132">132</a>
<a href="#L133" id="L133">133</a>
<a href="#L134" id="L134">134</a>
<a href="#L135" id="L135">135</a>
<a href="#L136" id="L136">136</a>
<a href="#L137" id="L137">137</a>
</pre></div>
<div class="highlight">
<div>
//&nbsp;MIT&nbsp;License
</div>
<div>
<br>
</div>
<div>
//&nbsp;Copyright&nbsp;(c)&nbsp;2017&nbsp;Vadim&nbsp;Grigoruk&nbsp;@nesbox&nbsp;//&nbsp;grigoruk@gmail.com
</div>
<div>
<br>
</div>
<div>
//&nbsp;Permission&nbsp;is&nbsp;hereby&nbsp;granted,&nbsp;free&nbsp;of&nbsp;charge,&nbsp;to&nbsp;any&nbsp;person&nbsp;obtaining&nbsp;a&nbsp;copy
</div>
<div>
//&nbsp;of&nbsp;this&nbsp;software&nbsp;and&nbsp;associated&nbsp;documentation&nbsp;files&nbsp;(the&nbsp;"Software"),&nbsp;to&nbsp;deal
</div>
<div>
//&nbsp;in&nbsp;the&nbsp;Software&nbsp;without&nbsp;restriction,&nbsp;including&nbsp;without&nbsp;limitation&nbsp;the&nbsp;rights
</div>
<div>
//&nbsp;to&nbsp;use,&nbsp;copy,&nbsp;modify,&nbsp;merge,&nbsp;publish,&nbsp;distribute,&nbsp;sublicense,&nbsp;and/or&nbsp;sell
</div>
<div>
//&nbsp;copies&nbsp;of&nbsp;the&nbsp;Software,&nbsp;and&nbsp;to&nbsp;permit&nbsp;persons&nbsp;to&nbsp;whom&nbsp;the&nbsp;Software&nbsp;is
</div>
<div>
//&nbsp;furnished&nbsp;to&nbsp;do&nbsp;so,&nbsp;subject&nbsp;to&nbsp;the&nbsp;following&nbsp;conditions:
</div>
<div>
<br>
</div>
<div>
//&nbsp;The&nbsp;above&nbsp;copyright&nbsp;notice&nbsp;and&nbsp;this&nbsp;permission&nbsp;notice&nbsp;shall&nbsp;be&nbsp;included&nbsp;in&nbsp;all
</div>
<div>
//&nbsp;copies&nbsp;or&nbsp;substantial&nbsp;portions&nbsp;of&nbsp;the&nbsp;Software.
</div>
<div>
<br>
</div>
<div>
//&nbsp;THE&nbsp;SOFTWARE&nbsp;IS&nbsp;PROVIDED&nbsp;"AS&nbsp;IS",&nbsp;WITHOUT&nbsp;WARRANTY&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;EXPRESS&nbsp;OR
</div>
<div>
//&nbsp;IMPLIED,&nbsp;INCLUDING&nbsp;BUT&nbsp;NOT&nbsp;LIMITED&nbsp;TO&nbsp;THE&nbsp;WARRANTIES&nbsp;OF&nbsp;MERCHANTABILITY,
</div>
<div>
//&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE&nbsp;AND&nbsp;NONINFRINGEMENT.&nbsp;IN&nbsp;NO&nbsp;EVENT&nbsp;SHALL&nbsp;THE
</div>
<div>
//&nbsp;AUTHORS&nbsp;OR&nbsp;COPYRIGHT&nbsp;HOLDERS&nbsp;BE&nbsp;LIABLE&nbsp;FOR&nbsp;ANY&nbsp;CLAIM,&nbsp;DAMAGES&nbsp;OR&nbsp;OTHER
</div>
<div>
//&nbsp;LIABILITY,&nbsp;WHETHER&nbsp;IN&nbsp;AN&nbsp;ACTION&nbsp;OF&nbsp;CONTRACT,&nbsp;TORT&nbsp;OR&nbsp;OTHERWISE,&nbsp;ARISING&nbsp;FROM,
</div>
<div>
//&nbsp;OUT&nbsp;OF&nbsp;OR&nbsp;IN&nbsp;CONNECTION&nbsp;WITH&nbsp;THE&nbsp;SOFTWARE&nbsp;OR&nbsp;THE&nbsp;USE&nbsp;OR&nbsp;OTHER&nbsp;DEALINGS&nbsp;IN&nbsp;THE
</div>
<div>
//&nbsp;SOFTWARE.
</div>
<div>
<br>
</div>
<div>
#include&nbsp;"tic80.h"
</div>
<div>
#include&nbsp;"script.h"
</div>
<div>
#include&nbsp;"tools.h"
</div>
<div>
#include&nbsp;"cart.h"
</div>
<div>
<br>
</div>
<div>
#include&nbsp;&lt;stdio.h&gt;
</div>
<div>
#include&nbsp;&lt;stdlib.h&gt;
</div>
<div>
#include&nbsp;&lt;string.h&gt;
</div>
<div>
<br>
</div>
<div>
#if&nbsp;defined(TIC_MODULE_EXT)
</div>
<div>
#include&nbsp;&lt;dlfcn.h&gt;
</div>
<div>
#endif
</div>
<div>
<br>
</div>
<div>
static&nbsp;void&nbsp;onTrace(void*&nbsp;data,&nbsp;const&nbsp;char*&nbsp;text,&nbsp;u8&nbsp;color)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic80*&nbsp;tic&nbsp;=&nbsp;(tic80*)data;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;if(tic-&gt;callback.trace)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic-&gt;callback.trace(text,&nbsp;color);
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
static&nbsp;void&nbsp;onError(void*&nbsp;data,&nbsp;const&nbsp;char*&nbsp;info)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic80*&nbsp;tic&nbsp;=&nbsp;(tic80*)data;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;if(tic-&gt;callback.error)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic-&gt;callback.error(info);
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
static&nbsp;void&nbsp;onExit(void*&nbsp;data)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic80*&nbsp;tic&nbsp;=&nbsp;(tic80*)data;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;if(tic-&gt;callback.exit)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic-&gt;callback.exit();
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
tic80*&nbsp;tic80_create(s32&nbsp;samplerate,&nbsp;tic80_pixel_color_format&nbsp;format)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&tic_core_create(samplerate,&nbsp;format)-&gt;product;
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
TIC80_API&nbsp;void&nbsp;tic80_load(tic80*&nbsp;tic,&nbsp;void*&nbsp;cart,&nbsp;s32&nbsp;size)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_mem*&nbsp;mem&nbsp;=&nbsp;(tic_mem*)tic;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_cart_load(&mem-&gt;cart,&nbsp;cart,&nbsp;size);
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;tic_script*&nbsp;script&nbsp;=&nbsp;tic_get_script(mem);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;if(script)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic_api_reset(mem);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;}
</div>
<div>
<br>
</div>
<div>
#if&nbsp;defined(TIC_MODULE_EXT)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;else
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char*&nbsp;tag&nbsp;=&nbsp;tic_tool_metatag(mem-&gt;cart.code.data,&nbsp;"script",&nbsp;NULL);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;name[128];
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(name,&nbsp;"%s"&nbsp;TIC_MODULE_EXT,&nbsp;tag);
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void*&nbsp;module&nbsp;=&nbsp;dlopen(name,&nbsp;RTLD_NOW&nbsp;|&nbsp;RTLD_LOCAL);
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(module)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;tic_script*&nbsp;config&nbsp;=&nbsp;dlsym(module,&nbsp;DEF2STR(SCRIPT_CONFIG));
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(config)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic_add_script(config);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tic_api_reset(mem);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dlclose(module);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;}
</div>
<div>
#endif
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
TIC80_API&nbsp;void&nbsp;tic80_tick(tic80*&nbsp;tic,&nbsp;tic80_input&nbsp;input,&nbsp;CounterCallback&nbsp;counter,&nbsp;FreqCallback&nbsp;freq)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_mem*&nbsp;mem&nbsp;=&nbsp;(tic_mem*)tic;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;mem-&gt;ram-&gt;input&nbsp;=&nbsp;input;
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_tick_data&nbsp;tickData&nbsp;=&nbsp;(tic_tick_data)
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.error&nbsp;=&nbsp;onError,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.trace&nbsp;=&nbsp;onTrace,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.exit&nbsp;=&nbsp;onExit,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.data&nbsp;=&nbsp;tic,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.start&nbsp;=&nbsp;0,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.counter&nbsp;=&nbsp;counter,
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.freq&nbsp;=&nbsp;freq
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;};
</div>
<div>
<br>
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_tick_start(mem);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_tick(mem,&nbsp;&tickData);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_tick_end(mem);
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_blit(mem);
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
TIC80_API&nbsp;void&nbsp;tic80_sound(tic80*&nbsp;tic)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_mem*&nbsp;mem&nbsp;=&nbsp;(tic_mem*)tic;
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_synth_sound(mem);
</div>
<div>
}
</div>
<div>
<br>
</div>
<div>
TIC80_API&nbsp;void&nbsp;tic80_delete(tic80*&nbsp;tic)
</div>
<div>
{
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_mem*&nbsp;mem&nbsp;=&nbsp;(tic_mem*)tic;
</div>
<div>
&nbsp;&nbsp;&nbsp;&nbsp;tic_core_close(mem);
</div>
<div>
}
</div>
</div>
</div></div>
</body>
</html>
</p>
