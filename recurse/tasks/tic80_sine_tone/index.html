<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="/recurse/css/style.css">
<meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
<div id="main">
<p><title>Inject a sine tone into tic80 audio pipeline</title>
<h1>Inject a sine tone into tic80 audio pipeline</h1>
task id: tic80-sine-tone
</p>
<p><a href="#2024_07_09_08_19" id="2024_07_09_08_19">2024-07-09 08:19</a>: Initial investigation completed, now onto initial challenge: sine tone test. #investigate-tic80-audio #tic80-sine-tone</p>
<div class="comment-block">
<p>I think I know about enough to get started on hacking in a sine tone into the TIC-80 sound codebase. 
</p>
<p> A sine tone is ideal because it's a pitched pure tone, and it can be easy to tell if I'm getting the buffering and sample rate correct. If I can get a sine.
</p>
</div>
<p><a href="#2024_07_10_11_14" id="2024_07_10_11_14">2024-07-10 11:14</a>: This would be a good day to try to work on this #tic80-sine-tone</p>
<p><a href="#2024_07_10_15_20" id="2024_07_10_15_20">2024-07-10 15:20</a>: Attempts to get a sine tone playing in tic80 #tic80-sine-tone #timelog:01:19:56</p>
<p><a href="#2024_07_10_15_24" id="2024_07_10_15_24">2024-07-10 15:24</a>: =update_amp()=, what does that do? #tic80-sine-tone</p>
<div class="comment-block">
<p>Ah, I don't think I have to care about that, I can process data directly.
</p>
</div>
<p><a href="#2024_07_10_16_22" id="2024_07_10_16_22">2024-07-10 16:22</a>: runPcm not working. going a level down. #tic80-sine-tone</p>
<p><a href="#2024_07_10_16_55" id="2024_07_10_16_55">2024-07-10 16:55</a>: Wow, I am having a hard time grokking this code #tic80-sine-tone</p>
<div class="comment-block">
<p>I don't understand what <code>update_amp</code> is doing. It seems to be some kind of delta encoding. 
</p>
<p> I'm just putting printf statements in functions now to see what runs and happens.
</p>
</div>
<p><a href="#2024_07_10_17_39" id="2024_07_10_17_39">2024-07-10 17:39</a>: the =tic_sound_register_data= is key #tic80-sine-tone</p>
<div class="comment-block">
<p>It can be found in <code>core.h</code>. The value I think that is relevant for an arbitrary sine tone is "amp", which is the "current amp in the delta buffer". Does that mean the amp is delta encoded or PCM encoded? 
</p>
<p> There are 4 channels of sound.
</p>
</div>
<p><a href="#2024_07_10_17_45" id="2024_07_10_17_45">2024-07-10 17:45</a>: Follow-ups #tic80-sine-tone</p>
<div class="comment-block">
<p>How can I print any non-zero sound PCM values to terminal? 
</p>
<p> What's the deal with registers? How do they end up in a PCM buffer?
</p>
</div>
<p><a href="#2024_07_11_08_33" id="2024_07_11_08_33">2024-07-11 08:33</a>: I have a few more ideas on how to do this #tic80-sine-tone</p>
<div class="comment-block">
<p>Look at <code>tic_core_sound_tick_start</code> and  <code>tic_core_sound_tick_end</code>.
</p>
</div>
<p><a href="#2024_07_11_09_01" id="2024_07_11_09_01">2024-07-11 09:01</a>: Another stab at this tic80 sound stuff #tic80-sine-tone</p>
<p><a href="#2024_07_11_09_18" id="2024_07_11_09_18">2024-07-11 09:18</a>: Flipping back to =studio_sound= again. Does it get called? #tic80-sine-tone</p>
<div class="comment-block">
<p>Yup, it's getting called.
</p>
</div>
<p><a href="#2024_07_11_09_22" id="2024_07_11_09_22">2024-07-11 09:22</a>: Back to sokol. Are we in sokol? #tic80-sine-tone</p>
<div class="comment-block">
<p>No. No we are not in Sokol.
</p>
</div>
<p><a href="#2024_07_11_09_26" id="2024_07_11_09_26">2024-07-11 09:26</a>: We are in SDL! #tic80-sine-tone</p>
<div class="comment-block">
<p>I've zoomed up to the top-most callback level which looks familiar enough to me. Still, it's doing stuff in a less than straight-forward way than usual. 
</p>
<p> This is the code worth digging into a bit, which is responsible for copying TIC-80 PCM data into SDL's audio buffer. I have reformatted it a bit to make it more readable. Initially, it was all on one line. 
<pre><code>*stream++ =
((u8*)tic-&gt;product.samples.buffer[
    tic-&gt;product.samples.count *
    TIC80_SAMPLESIZE -
    platform.audio.bufferRemaining--
];</pre></code>
<p></p>
<p> The <code>stream</code> variable here is a chunk of u8 vars. 
</p>
<p> The <code>TIC80_SAMPLESIZE</code> ends up being 2. This could either mean it's a stereo frame of 8-bit values, or the sample type is 16-bit and the samples are interleaved if it's stereo. Unclear. 
</p>
<p> The <code>bufferRemaining</code> variable is decreasing by 1 every sample, and being subtracted from the total number of bytes that the buffer has. This feels like a bit of round-a-about way to avoid using a for loop structure. 
</p>
<p> When the audio buffer counter goes to zero, it fills up the tic80 buffer again using <code>studio_sound</code>. It continues doing this until the SDL buffer is filled.
</p>
</div>
<p><a href="#2024_07_11_09_50" id="2024_07_11_09_50">2024-07-11 09:50</a>: =tic_core_synth_sound= updates tail #tic80-sine-tone</p>
<div class="comment-block">
<p>Meanwhile, <code>tic_core_synth_head</code> updates the head. The relevant bits of code look almost identical.
</p>
</div>
<p><a href="#2024_07_11_09_53" id="2024_07_11_09_53">2024-07-11 09:53</a>: Just printed tick start/ends and sound synth #tic80-sine-tone</p>
<div class="comment-block">
<p>There's some kind of async stuff happening I think. A tick start always follows up with a tick end, so that's being called on one thread. Meanwhile, the synth sound function can be called a few times in between these ticks. Sometimes once or twice, or not at all.
</p>
</div>
<p><a href="#2024_07_11_09_56" id="2024_07_11_09_56">2024-07-11 09:56</a>: Where are the tick start/end functions being called? #tic80-sine-tone</p>
<div class="comment-block">
<p>There's mention of a <code>tic80_tick</code> function, but when I try to printf from it, nothing shows up. 
</p>
<p> Okay found it! inside <code>gpuTick()</code> from SDL, the call chain is <code>studio_tick</code>, <code>renderStudio</code>, then calls to <code>tic_core_tick_start</code> and <code>tic_core_tick_end</code>, which makes calls to the sound tick starts and ends.
</p>
</div>
<p><a href="#2024_07_11_10_10" id="2024_07_11_10_10">2024-07-11 10:10</a>: That's enough for now #tic80-sine-tone #timelog:01:13:35</p>
<div class="comment-block">
<p>It's looking to be an interesting sound problem, because the timing of sound rendering is related to the drawing callback. There's things like jitter and frame-drops. How does it handle that sort of thing? Does the so-called "blip buffer" smooth things out somehow?
</p>
</div>
</div>
</body>
</html>
